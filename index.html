<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Pictionary — French Monuments (1v1 Sync)</title>
<style>
:root{--accent:#1f7ed0}
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;margin:18px;background:#f6fbff;color:#0b2433}
.wrap{max-width:1200px;margin:0 auto;display:grid;grid-template-columns:360px 1fr;gap:18px}
.panel{background:white;border-radius:12px;padding:14px;box-shadow:0 8px 30px rgba(20,40,60,.06);display:flex;flex-direction:column;}
h1{margin:0 0 12px;font-size:20px}
select,input,button{padding:8px;border-radius:8px;border:1px solid #e6eef9;background:transparent;font-size:13px}
.reference{margin-top:10px;font-size:16px;font-weight:bold}
.reference img{margin-top:8px;max-width:100%;border-radius:8px;border:1px solid #eee}
.toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
#drawCanvas{background:#fff;border-radius:8px;border:1px solid #e6eef9;touch-action:none;width:100%;height:100%;}
.controls{display:flex;gap:8px;align-items:center;margin-top:10px;flex-wrap:wrap}
.small{font-size:13px;color:#47606f}
.right-top{display:flex;justify-content:space-between;align-items:center}
.score{font-weight:700;font-size:18px}
.room { margin-top:10px; display:flex; gap:8px; align-items:center; }
.input { padding:8px; border-radius:8px; border:1px solid #e6eef9; }
.status { margin-top:8px; font-size:13px; color:#3b82f6; }
.hidden{display:none}
</style>
</head>
<body>
<div style="max-width:1200px;margin:0 auto"><h1>Pictionary — French Monuments</h1></div>
<div class="wrap">
  <!-- Left -->
  <div class="panel">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <div class="small">Mode</div>
        <select id="modeSelect">
          <option value="single">Singleplayer</option>
          <option value="duel">1 vs 1</option>
        </select>
      </div>
      <div>
        <div class="small">Level</div>
        <select id="levelSelect">
          <option value="easy">Easy</option>
          <option value="medium">Medium</option>
          <option value="hard">Hard</option>
        </select>
      </div>
    </div>

    <div class="reference" id="referenceBox" style="display:block">
      <strong id="topicName"></strong>
      <div class="small" id="topicDiff"></div>
    </div>

    <div class="toolbar">
      <button id="newBtn">New Topic</button>
      <button id="startBtn" class="primary">Start Round (1:30)</button>
      <button id="clearBtn">Clear</button>
      <button id="resetBtn">Reset</button>
    </div>

    <div class="room">
      <button id="hostBtn">Host Game</button>
      <input id="joinInput" class="input" placeholder="Join code (e.g. ABC12)" />
      <button id="joinBtn">Join</button>
    </div>
    <div id="roomInfo" class="status">Not in a room</div>
    <div id="roleInfo" class="status"></div>
  </div>

  <!-- Right -->
  <div class="panel" style="display:flex;flex-direction:column;">
    <div class="right-top">
      <div>
        <div class="small">Timer</div>
        <div id="timerDisplay" style="font-size:20px;font-weight:700;color:#2563eb">01:30</div>
      </div>
      <div style="text-align:right">
        <div class="small">Score</div>
        <div id="scoreDisplay" class="score">—/100</div>
      </div>
    </div>

    <div style="flex:1">
      <canvas id="drawCanvas"></canvas>
    </div>

    <div class="controls">
      <label>Brush: <input id="brushSize" type="range" min="1" max="60" value="6"></label>
      <label>Opacity: <input id="opacity" type="range" min="0.1" max="1" step="0.1" value="1"></label>
      <label>Color: <input id="colorPicker" type="color" value="#000000"></label>
      <button id="eraserBtn">Eraser</button>
      <button id="penBtn">Pen</button>
      <button id="undoBtn">Undo</button>
      <button id="redoBtn">Redo</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import {
  getDatabase, ref, set, get, child, onValue, push, onChildAdded, remove, update
} from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDY0G9cCRmte-Nj5bIkkFsexrhN57KWH9I",
  authDomain: "pictionary-b6c8b.firebaseapp.com",
  databaseURL: "https://pictionary-b6c8b-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "pictionary-b6c8b",
  storageBucket: "pictionary-b6c8b.firebasedatabase.app",
  messagingSenderId: "319103864663",
  appId: "1:319103864663:web:3fb1aa8a38db68b95e3812",
  measurementId: "G-JX2LKWPX6Y"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const TOPICS = {
  easy: [ { name: 'Eiffel Tower' }, { name: 'Arc de Triomphe' } ],
  medium: [ { name: 'Notre-Dame de Paris' }, { name: 'Louvre Pyramid' } ],
  hard: [ { name: 'Pantheon' }, { name: 'Arene de Nimes' } ]
};

const modeSelect = document.getElementById('modeSelect');
const levelSelect = document.getElementById('levelSelect');
const newBtn = document.getElementById('newBtn');
const startBtn = document.getElementById('startBtn');
const clearBtn = document.getElementById('clearBtn');
const hostBtn = document.getElementById('hostBtn');
const joinBtn = document.getElementById('joinBtn');
const joinInput = document.getElementById('joinInput');
const roomInfo = document.getElementById('roomInfo');
const roleInfo = document.getElementById('roleInfo');
const topicNameEl = document.getElementById('topicName');
const topicDiffEl = document.getElementById('topicDiff');
const timerDisplay = document.getElementById('timerDisplay');
const scoreDisplay = document.getElementById('scoreDisplay');
const canvas = document.getElementById('drawCanvas');
const ctx = canvas.getContext('2d');

let dpr = window.devicePixelRatio || 1;
function resizeCanvas(){
  const rect = canvas.parentElement.getBoundingClientRect();
  canvas.width = Math.floor(rect.width * dpr);
  canvas.height = Math.floor(rect.height * dpr);
  ctx.setTransform(1,0,0,1,0,0);
  ctx.scale(dpr,dpr);
}
window.addEventListener('resize', ()=> setTimeout(resizeCanvas,50));
setTimeout(resizeCanvas,50);

let history = [], redoStack = [];
function pushHistory(){ history.push(canvas.toDataURL()); if(history.length>80) history.shift(); redoStack=[]; }
function restoreFromDataURL(dataURL){
  const img = new Image();
  img.onload = ()=>{ ctx.setTransform(1,0,0,1,0,0); ctx.scale(dpr,dpr); ctx.clearRect(0,0,canvas.width/dpr,canvas.height/dpr); ctx.drawImage(img,0,0,canvas.width/dpr,canvas.height/dpr); };
  img.src = dataURL;
}

let drawing=false, started=false, timeLeft=90;
ctx.lineCap='round'; ctx.lineJoin='round';
let currentRoom = null, isHost = false;

function ptrPos(e){ const r = canvas.getBoundingClientRect(); return { x: e.clientX - r.left, y: e.clientY - r.top }; }
canvas.addEventListener('pointerdown', (e)=>{ drawing=true; const p=ptrPos(e); ctx.beginPath(); ctx.moveTo(p.x,p.y); pushHistory(); });
canvas.addEventListener('pointermove', (e)=>{ if(!drawing) return; const p=ptrPos(e); ctx.lineTo(p.x,p.y); ctx.stroke(); });
canvas.addEventListener('pointerup', ()=>{ if(!drawing) return; drawing=false; ctx.closePath(); });
canvas.addEventListener('pointerleave', ()=>{ if(!drawing) return; drawing=false; ctx.closePath(); });

function pickTopic(level){ const arr = TOPICS[level] || TOPICS.easy; return arr[Math.floor(Math.random()*arr.length)]; }
function setReference(topic, level){ topicNameEl.textContent = topic.name; topicDiffEl.textContent = level.charAt(0).toUpperCase() + level.slice(1); }

newBtn.addEventListener('click', ()=>{ const t = pickTopic(levelSelect.value); setReference(t, levelSelect.value); pushHistory(); });
levelSelect.addEventListener('change', ()=>{ const t = pickTopic(levelSelect.value); setReference(t, levelSelect.value); });

function updateTimerDisplay(){ const m = Math.floor(timeLeft/60).toString().padStart(2,'0'); const s = (timeLeft%60).toString().padStart(2,'0'); timerDisplay.textContent = `${m}:${s}`; }

function startRoundLocal(topicData){
  if(started) return;
  started = true;
  timeLeft = 90;
  updateTimerDisplay();
  setReference(topicData, topicData.level);
  const timerInterval = setInterval(()=>{
    if(timeLeft<=0){ clearInterval(timerInterval); started=false; } else { timeLeft--; updateTimerDisplay(); }
  }, 1000);
}

startBtn.addEventListener('click', async ()=>{
  if(modeSelect.value==="duel" && currentRoom && isHost){
    const topic = pickTopic(levelSelect.value);
    await update(ref(db,'rooms/'+currentRoom), { started:true, topic:topic, level:levelSelect.value });
  }
  startRoundLocal({ name:topicNameEl.textContent, level:levelSelect.value });
});

hostBtn.addEventListener('click', async ()=>{
  const code = Math.random().toString(36).substring(2,7).toUpperCase();
  currentRoom = code;
  isHost = true;
  const topic = pickTopic(levelSelect.value);
  await set(ref(db, 'rooms/' + code), { createdAt: Date.now(), started: false, topic: topic, level: levelSelect.value });
  roomInfo.textContent = 'Room: ' + code;
  roleInfo.textContent = 'You are Host';
  setReference(topic, levelSelect.value);

  onValue(ref(db,'rooms/'+currentRoom),snap=>{
    if(snap.exists()){
      const data = snap.val();
      if(data.started) startRoundLocal(data.topic);
    }
  });
});

joinBtn.addEventListener('click', async ()=>{
  const code = (joinInput.value || '').trim().toUpperCase();
  if(!code){ alert('Enter a room code'); return; }
  const snap = await get(child(ref(db), 'rooms/' + code));
  if(!snap.exists()){ alert('Room not found'); return; }
  currentRoom = code;
  isHost = false;
  roomInfo.textContent = 'Room: ' + code;
  roleInfo.textContent = 'You are Guest';
  const data = snap.val();
  setReference(data.topic,data.level);

  onValue(ref(db,'rooms/'+currentRoom),snap=>{
    if(snap.exists()){
      const data = snap.val();
      if(data.started) startRoundLocal(data.topic);
    }
  });
});

window.addEventListener('load', ()=>{
  const t = pickTopic(levelSelect.value);
  setReference(t, levelSelect.value);
  updateTimerDisplay();
  scoreDisplay.textContent = '—/100';
});
</script>
</body>
</html>
