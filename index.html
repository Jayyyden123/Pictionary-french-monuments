<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Pictionary — French Monuments</title>
<style>
:root{--accent:#1f7ed0}
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;margin:18px;background:#f6fbff;color:#0b2433}
.wrap{max-width:1200px;margin:0 auto;display:grid;grid-template-columns:360px 1fr;gap:18px}
.panel{background:white;border-radius:12px;padding:14px;box-shadow:0 8px 30px rgba(20,40,60,.06);display:flex;flex-direction:column;}
h1{margin:0 0 12px;font-size:20px}
select,input,button{padding:8px;border-radius:8px;border:1px solid #e6eef9;background:transparent;font-size:13px}
.reference{margin-top:10px;font-size:16px;font-weight:bold}
.toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
#drawCanvas{background:#fff;border-radius:8px;border:1px solid #e6eef9;touch-action:none;width:100%;height:100%;}
.controls{display:flex;gap:8px;align-items:center;margin-top:10px;flex-wrap:wrap}
.small{font-size:13px;color:#47606f}
.right-top{display:flex;justify-content:space-between;align-items:center}
button.primary{background:var(--accent);color:white;border:none;cursor:pointer}
button:disabled{opacity:0.5;cursor:not-allowed}
.score{font-weight:700;font-size:18px}
.room { margin-top:10px; display:flex; gap:8px; align-items:center; }
.input { padding:8px; border-radius:8px; border:1px solid #e6eef9; }
.status { margin-top:8px; font-size:13px; color:#3b82f6; }
.hidden{display:none}
.panel > div[style*="flex:1"] {
  min-height: 400px; /* Ensure canvas container has height */
}
</style>
</head>
<body>
<div style="max-width:1200px;margin:0 auto"><h1>Pictionary — French Monuments</h1></div>
<div class="wrap">
  <div class="panel">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <div class="small">Mode</div>
        <select id="modeSelect">
          <option value="single">Singleplayer</option>
          <option value="duel">1 vs 1 Duel</option>
        </select>
      </div>
      <div>
        <div class="small">Level</div>
        <select id="levelSelect">
          <option value="easy">Easy</option>
          <option value="medium">Medium</option>
          <option value="hard">Hard</option>
        </select>
      </div>
    </div>

    <div class="reference" id="referenceBox" style="display:none;">
      <strong id="topicName"></strong>
      <div class="small" id="topicDiff"></div>
    </div>

    <div class="toolbar">
      <button id="newBtn">New Topic</button>
      <button id="startBtn" class="primary">Start Round (1:30)</button>
      <button id="clearBtn">Clear</button>
      <button id="resetBtn">Reset</button>
    </div>

    <div class="room">
      <button id="hostBtn">Host Game</button>
      <input id="joinInput" class="input" placeholder="Join code (e.g. ABC123)" maxlength="6" />
      <button id="joinBtn">Join</button>
    </div>
    <div id="roomInfo" class="status">Not in a room</div>
    <div id="roleInfo" class="status"></div>
  </div>

  <div class="panel" style="display:flex;flex-direction:column;">
    <div class="right-top">
      <div>
        <div class="small">Timer</div>
        <div id="timerDisplay" style="font-size:20px;font-weight:700;color:#2563eb">01:30</div>
      </div>
      <div style="text-align:right">
        <div class="small">Score</div>
        <div id="scoreDisplay" class="score">—/100</div>
      </div>
    </div>

    <div style="flex:1">
      <canvas id="drawCanvas"></canvas>
    </div>

    <div class="controls">
      <label>Brush: <input id="brushSize" type="range" min="1" max="60" value="6"></label>
      <label>Opacity: <input id="opacity" type="range" min="0.1" max="1" step="0.1" value="1"></label>
      <label>Color: <input id="colorPicker" type="color" value="#000000"></label>
      <button id="eraserBtn">Eraser</button>
      <button id="penBtn" style="box-shadow: inset 0 0 0 2px rgba(0,0,0,.06);">Pen</button>
      <button id="undoBtn">Undo</button>
      <button id="redoBtn">Redo</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import {
  getDatabase, ref, set, get, onValue, push, remove, update, onChildAdded, off
} from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";

// Replace with your Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyDY0G9cCRmte-Nj5bIkkFsexrhN57KWH9I",
  authDomain: "pictionary-b6c8b.firebaseapp.com",
  databaseURL: "https://pictionary-b6c8b-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "pictionary-b6c8b",
  storageBucket: "pictionary-b6c8b.firebasestorage.app",
  messagingSenderId: "319103864663",
  appId: "1:319103864663:web:3fb1aa8a38db68b95e3812",
  measurementId: "G-JX2LKWPX6Y"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const TOPICS = {
  easy: ["Eiffel Tower","Arc de Triomphe"],
  medium: ["Notre-Dame de Paris","Louvre Pyramid"],
  hard: ["Panthéon","Arènes de Nîmes"]
};

const modeSelect = document.getElementById('modeSelect');
const levelSelect = document.getElementById('levelSelect');
const newBtn = document.getElementById('newBtn');
const startBtn = document.getElementById('startBtn');
const clearBtn = document.getElementById('clearBtn');
const resetBtn = document.getElementById('resetBtn');
const hostBtn = document.getElementById('hostBtn');
const joinBtn = document.getElementById('joinBtn');
const joinInput = document.getElementById('joinInput');
const roomInfo = document.getElementById('roomInfo');
const roleInfo = document.getElementById('roleInfo');

const referenceBox = document.getElementById('referenceBox');
const topicNameEl = document.getElementById('topicName');
const topicDiffEl = document.getElementById('topicDiff');

const timerDisplay = document.getElementById('timerDisplay');
const scoreDisplay = document.getElementById('scoreDisplay');
const canvas = document.getElementById('drawCanvas');
const ctx = canvas.getContext('2d');

const brushSize = document.getElementById('brushSize');
const opacityEl = document.getElementById('opacity');
const colorPicker = document.getElementById('colorPicker');
const eraserBtn = document.getElementById('eraserBtn');
const penBtn = document.getElementById('penBtn');
const undoBtn = document.getElementById('undoBtn');
const redoBtn = document.getElementById('redoBtn');

let dpr = window.devicePixelRatio || 1;
function resizeCanvas(){
  const rect = canvas.parentElement.getBoundingClientRect();
  canvas.style.width = rect.width + 'px';
  canvas.style.height = rect.height + 'px';
  canvas.width = Math.floor(rect.width * dpr);
  canvas.height = Math.floor(rect.height * dpr);
  ctx.setTransform(1,0,0,1,0,0);
  ctx.scale(dpr,dpr);
  redrawHistory();
}
window.addEventListener('resize', ()=> setTimeout(resizeCanvas,50));
setTimeout(resizeCanvas,50);

let history = [], redoStack = [];
function pushHistory(){
  try {
    const imgData = ctx.getImageData(0,0,canvas.width,canvas.height);
    history.push(imgData);
    if(history.length > 80) history.shift();
    redoStack = [];
  } catch(e){}
}
function restoreFromImageData(imgData){
  ctx.putImageData(imgData,0,0);
}
function redrawHistory(){
  if(history.length > 0){
    restoreFromImageData(history[history.length-1]);
  } else {
    ctx.clearRect(0,0,canvas.width/dpr,canvas.height/dpr);
  }
}

let drawing = false;
let erasing = false;
let started = false;
let timer = null;
let timeLeft = 90;
let currentMode = 'single';
let currentTopic = '';
let currentLevel = 'easy';
let score = null;

let roomCode = null;
let isHost = false;
let roomRef = null;
let strokesRef = null;
let strokesListener = null;
let topicRef = null;
let timerRef = null;
let scoreRef = null;

const clientId = Math.random().toString(36).slice(2,9);

ctx.lineCap = 'round';
ctx.lineJoin = 'round';
ctx.lineWidth = brushSize.value;
ctx.globalAlpha = opacityEl.value;
ctx.strokeStyle = colorPicker.value;
ctx.globalCompositeOperation = 'source-over';

// UTILS
function pickTopic(level){
  const arr = TOPICS[level] || TOPICS.easy;
  return arr[Math.floor(Math.random()*arr.length)];
}

function setReference(topic, level){
  currentTopic = topic;
  currentLevel = level;
  topicNameEl.textContent = topic;
  topicDiffEl.textContent = level.charAt(0).toUpperCase() + level.slice(1);
  referenceBox.style.display = 'block';
  updateScoreDisplay(null);
}

function updateTimerDisplay(){
  const m = Math.floor(timeLeft/60).toString().padStart(2,'0');
  const s = (timeLeft%60).toString().padStart(2,'0');
  timerDisplay.textContent = `${m}:${s}`;
}

function updateScoreDisplay(val){
  if(val === null || val === undefined){
    scoreDisplay.textContent = '—/100';
    score = null;
  } else {
    scoreDisplay.textContent = `${val}/100`;
    score = val;
  }
}

function setControlsEnabled(enabled){
  newBtn.disabled = !enabled;
  startBtn.disabled = !enabled;
  clearBtn.disabled = !enabled;
  resetBtn.disabled = !enabled;
  brushSize.disabled = !enabled;
  opacityEl.disabled = !enabled;
  colorPicker.disabled = !enabled;
  eraserBtn.disabled = !enabled;
  penBtn.disabled = !enabled;
  undoBtn.disabled = !enabled;
  redoBtn.disabled = !enabled;
  levelSelect.disabled = !enabled;
  modeSelect.disabled = !enabled;
  hostBtn.disabled = !(enabled && currentMode === 'duel');
  joinInput.disabled = !(enabled && currentMode === 'duel');
  joinBtn.disabled = !(enabled && currentMode === 'duel');
}

function clearCanvas(){
  ctx.clearRect(0,0,canvas.width/dpr,canvas.height/dpr);
}

function resetGameState(){
  clearInterval(timer);
  timer = null;
  started = false;
  timeLeft = 90;
  updateTimerDisplay();
  updateScoreDisplay(null);
  clearCanvas();
  history = [];
  redoStack = [];
  setControlsEnabled(true);
  referenceBox.style.display = 'none';
  currentTopic = '';
  currentLevel = levelSelect.value;
  score = null;
  roomInfo.textContent = 'Not in a room';
  roleInfo.textContent = '';
  roomCode = null;
  isHost = false;
  if(roomRef) {
    off(roomRef);
    roomRef = null;
  }
  if(strokesRef && strokesListener) {
    strokesRef.off('child_added', strokesListener);
    strokesRef = null;
    strokesListener = null;
  }
  if(topicRef) {
    topicRef.off();
    topicRef = null;
  }
  if(timerRef) {
    timerRef.off();
    timerRef = null;
  }
  if(scoreRef) {
    scoreRef.off();
    scoreRef = null;
  }
}

// DRAWING EVENTS
function ptrPos(e){
  const rect = canvas.getBoundingClientRect();
  return { x: e.clientX - rect.left, y: e.clientY - rect.top };
}

canvas.addEventListener('pointerdown', (e)=>{
  if(!started) return;
  drawing = true;
  const p = ptrPos(e);
  ctx.beginPath();
  ctx.moveTo(p.x, p.y);
  pushHistory();
  if(currentMode === 'duel' && roomCode) {
    sendDrawEvent({type:'begin', x:p.x, y:p.y, color:ctx.strokeStyle, width:ctx.lineWidth, opacity:ctx.globalAlpha, erasing});
  }
});
canvas.addEventListener('pointermove', (e)=>{
  if(!drawing) return;
  const p = ptrPos(e);
  ctx.lineTo(p.x, p.y);
  ctx.strokeStyle = erasing ? 'rgba(0,0,0,1)' : colorPicker.value;
  ctx.lineWidth = brushSize.value;
  ctx.globalCompositeOperation = erasing ? 'destination-out' : 'source-over';
  ctx.globalAlpha = opacityEl.value;
  ctx.stroke();
  if(currentMode === 'duel' && roomCode) {
    sendDrawEvent({type:'draw', x:p.x, y:p.y, color:ctx.strokeStyle, width:ctx.lineWidth, opacity:ctx.globalAlpha, erasing});
  }
});
canvas.addEventListener('pointerup', ()=>{
  if(drawing){
    drawing = false;
    ctx.closePath();
    if(currentMode === 'duel' && roomCode) {
      sendDrawEvent({type:'end'});
    }
  }
});
canvas.addEventListener('pointerleave', ()=>{
  if(drawing){
    drawing = false;
    ctx.closePath();
    if(currentMode === 'duel' && roomCode) {
      sendDrawEvent({type:'end'});
    }
  }
});

// TOOL BUTTONS
eraserBtn.addEventListener('click', ()=>{
  erasing = true;
  eraserBtn.style.boxShadow = 'inset 0 0 0 2px rgba(0,0,0,.06)';
  penBtn.style.boxShadow = '';
  ctx.strokeStyle = 'rgba(0,0,0,1)';
});
penBtn.addEventListener('click', ()=>{
  erasing = false;
  penBtn.style.boxShadow = 'inset 0 0 0 2px rgba(0,0,0,.06)';
  eraserBtn.style.boxShadow = '';
  ctx.strokeStyle = colorPicker.value;
});
brushSize.addEventListener('input', ()=>{ ctx.lineWidth = brushSize.value; });
opacityEl.addEventListener('input', ()=>{ ctx.globalAlpha = opacityEl.value; });
colorPicker.addEventListener('input', ()=>{
  if(!erasing) ctx.strokeStyle = colorPicker.value;
});

// UNDO/REDO
undoBtn.addEventListener('click', ()=>{
  if(history.length === 0) return;
  redoStack.push(history.pop());
  if(history.length === 0){
    clearCanvas();
  } else {
    restoreFromImageData(history[history.length-1]);
  }
  if(currentMode === 'duel' && roomCode) {
    sendClearOrUndo('undo');
  }
});
redoBtn.addEventListener('click', ()=>{
  if(redoStack.length === 0) return;
  const imgData = redoStack.pop();
  history.push(imgData);
  restoreFromImageData(imgData);
  if(currentMode === 'duel' && roomCode) {
    sendClearOrUndo('redo');
  }
});

// CLEAR / RESET
clearBtn.addEventListener('click', ()=>{
  clearCanvas();
  pushHistory();
  updateScoreDisplay(null);
  if(currentMode === 'duel' && roomCode) {
    sendClearOrUndo('clear');
  }
});

resetBtn.addEventListener('click', ()=>{
  resetGameState();
  if(currentMode === 'duel' && roomCode) {
    sendReset();
  }
});

// TIMER
function startTimer(){
  if(started) return;
  started = true;
  timeLeft = 90;
  updateTimerDisplay();
  setControlsEnabled(false);
  timer = setInterval(()=>{
    timeLeft--;
    updateTimerDisplay();
    if(timeLeft <= 0){
      clearInterval(timer);
      timer = null;
      started = false;
      setControlsEnabled(true);
      if(currentMode === 'single'){
        endRoundSingle();
      } else if(currentMode === 'duel' && roomCode && isHost){
        endRoundDuel();
      }
    }
  }, 1000);
}

function stopTimer(){
